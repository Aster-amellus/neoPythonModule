# Proj-04

SimpleBiliToolbox

> 简易B站工具箱

*Still Under Building...*

我~~们~~终于决定要编写一个多功能的B站工具箱了。

在规划中，这个程序分为三层 —— API层、核心层、UI层。

| Layer  | Desc                       |
| ------ | -------------------------- |
| 接口层 | 封装B站的API供其余部分调用 |
| 核心层 | 下载器、来源解析等功能组件 |
| UI层   | 与用户交互的部分，CLI或GUI |

## Part.I API层

我们将要编写一个能供外界调用的模块。此时我们的用户是其他的程序员，所以我们需要写好类型标注、注释和`docstring`等，就像那些超好用的第三方库一样。

### 模块结构设计

最简单的结构，当然是用函数将requests的网络请求和url一同封装成函数，同时将接口中的参数选择性地转换为函数的参数。将这些函数分成不同部分放到不同的py文件中，最后写个`__init__.py`封顶，就大功告成了！就像这样：

```
biliapis
│  audio.py
│  bilicodes.py
│  error.py
│  login.py
│  manga.py
│  media.py
│  video.py
│  wbi.py
└─ __init__.py
```

—— 但是这只是最简单的设想。

#### 模块分类

实际一做就会发现，有一些特殊的部分应该与别的部分区分开。比如上面的`bilicodes.py`中定义了B站API中的一些常见的状态码和枚举数据；`error.py`中定义了`BiliError`异常类；`wbi.py`会为别的部分提供签名服务而不是供用户调用。

那我们就将它们抽离出来，其余模块下沉一级：

```
biliapis
│  bilicodes.py
│  error.py
│  wbi.py
│  __init__.py
│
└─ apis
   │  audio.py
   │  login.py
   │  manga.py
   │  media.py
   │  video.py
   └─ __init__.py
```

好！

#### 代码复用

那么另一个问题是，要在每个分类的每个接口函数中都写一遍完整的请求流程吗？这也太不复用了吧……

这个也简单，我们将重复的部分抽取出来做成函数，每个接口函数中都使用这些会重复用到的代码包装成的函数，就好了！

> 在示例代码中我因为在写了先前的装饰器部分之后有点上头，所以这些「会重复用到的代码」全被我弄成了装饰器，所以示例代码和我所述的可能会「稍微」有点不一样（逃）

#### 登录会话

嗯还有一个问题，要想获取到B站的高画质和付费番剧等资源，你需要登录。登录信息保存在Cookies中，而Cookies保存在`requests.Session`中。稍微翻看一下`requests`的源代码发现，如果直接使用`requests`模块中的`get` `post` `head`等函数，`requests`实际上会临时新建一个`Session`出来使用，Cookies无法持久保留。

那怎么办呢？在每个接口函数的参数列表中额外增加一个session参数吗？感觉有点怪怪的 ~~，给我干哪来了这还是面向对象吗~~

那把session写成文件里的全局变量？感觉更怪了。但是除了这俩似乎没有更好的解决方法了……吗？

#### 多登录会话共存

先来看再一个问题，假如使用我们的模块的开发人员想实现一个允许多个账号同时存在的工具箱（一个账号对于一个资源没有权限就换下一个账号去取那种），那用文件内全局变量的方法显然就不够灵活了。每个接口函数都传入session呢，又有点嫌繁琐。

> ~~唉唉这种时候就应该把提出问题的用户狠狠击倒在地~~

